<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Favourite Food Voter</title>
    <link href="public/styles.css" rel="stylesheet" type="text/css" />
    <script src="script.js"></script>
    <link rel="shortcut icon" href="#">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,700;1,100&display=swap" rel="stylesheet">
</head>

<body class="flex flex-column font-roboto">
    <!-- Side Bar -->
    <div style="background-image: url('assets/HelloBg.jpg');" class="h-screen w-1/2 bg-cover bg-center text-white">
        <h1 class="text-7xl text-center ml-24 mt-24 mr-24 mb-4">Favourite Foods</h1>
        <p class="text-xl ml-32">Welcome to the favourite foods poll,</p>
        <p class="text-xl ml-32">Click enter app to begin!</p>

        <!-- Bottom Bar -->
        <div class="w-1/2 h-24 absolute bottom-0 bg-lightCyan">

        </div>
    </div>

    <!-- The other bit -->
    <div class="p-0 m-0">
        <!-- Hello Box -->
        <div style="background-image: url('assets/Berries.jpg');" class=" rounded-2xl mt-6 ml-48 mr-48 h-96 w-96 bg-center bg-cover drop-shadow-md">
        </div>

        <!-- Login -->
        <div class="md:flex md:justify-center w-72 h-24 rounded-2xl mt-20 ml-60 mr-60 bg-darkCyan drop-shadow-md text-center text-white">
            <button id="login-btn" class="text-center">Enter App</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" crossorigin="anonymous"></script>

    <script>
        $(document).ready(function() {
            web3 = new Web3(web3.currentProvider);

            var address = "0xB71Fb0E9267df0BdAdC43404E66cEDe2A12079F0";
            var abi = [{
                "anonymous": false,
                "inputs": [{
                    "indexed": false,
                    "internalType": "uint256",
                    "name": "candidateId",
                    "type": "uint256"
                }],
                "name": "Voted",
                "type": "event"
            }, {
                "inputs": [{
                    "internalType": "uint256",
                    "name": "",
                    "type": "uint256"
                }],
                "name": "candidateAccts",
                "outputs": [{
                    "internalType": "uint256",
                    "name": "",
                    "type": "uint256"
                }],
                "stateMutability": "view",
                "type": "function"
            }, {
                "inputs": [],
                "name": "candidateKey",
                "outputs": [{
                    "internalType": "uint256",
                    "name": "",
                    "type": "uint256"
                }],
                "stateMutability": "view",
                "type": "function"
            }, {
                "inputs": [{
                    "internalType": "uint256",
                    "name": "",
                    "type": "uint256"
                }],
                "name": "candidates",
                "outputs": [{
                    "internalType": "uint256",
                    "name": "votes",
                    "type": "uint256"
                }, {
                    "internalType": "string",
                    "name": "name",
                    "type": "string"
                }],
                "stateMutability": "view",
                "type": "function"
            }, {
                "inputs": [{
                    "internalType": "string",
                    "name": "_name",
                    "type": "string"
                }],
                "name": "creatCandidate",
                "outputs": [{
                    "internalType": "uint256",
                    "name": "",
                    "type": "uint256"
                }],
                "stateMutability": "nonpayable",
                "type": "function"
            }, {
                "inputs": [],
                "name": "createVoter",
                "outputs": [{
                    "internalType": "string",
                    "name": "",
                    "type": "string"
                }],
                "stateMutability": "nonpayable",
                "type": "function"
            }, {
                "inputs": [{
                    "internalType": "address",
                    "name": "_address",
                    "type": "address"
                }],
                "name": "delegate",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }, {
                "inputs": [{
                    "internalType": "uint256",
                    "name": "_key",
                    "type": "uint256"
                }],
                "name": "getCandidateVotes",
                "outputs": [{
                    "internalType": "uint256",
                    "name": "",
                    "type": "uint256"
                }],
                "stateMutability": "view",
                "type": "function"
            }, {
                "inputs": [],
                "name": "getVoterVotes",
                "outputs": [{
                    "internalType": "uint256",
                    "name": "",
                    "type": "uint256"
                }],
                "stateMutability": "view",
                "type": "function"
            }, {
                "inputs": [],
                "name": "getamountOfCandidates",
                "outputs": [{
                    "internalType": "uint256",
                    "name": "",
                    "type": "uint256"
                }],
                "stateMutability": "view",
                "type": "function"
            }, {
                "inputs": [],
                "name": "hasVoted",
                "outputs": [{
                    "internalType": "bool",
                    "name": "",
                    "type": "bool"
                }],
                "stateMutability": "view",
                "type": "function"
            }, {
                "inputs": [{
                    "internalType": "uint256",
                    "name": "_key",
                    "type": "uint256"
                }],
                "name": "vote",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }, {
                "inputs": [{
                    "internalType": "uint256",
                    "name": "",
                    "type": "uint256"
                }],
                "name": "voterAccts",
                "outputs": [{
                    "internalType": "address",
                    "name": "",
                    "type": "address"
                }],
                "stateMutability": "view",
                "type": "function"
            }, {
                "inputs": [{
                    "internalType": "address",
                    "name": "",
                    "type": "address"
                }],
                "name": "voters",
                "outputs": [{
                    "internalType": "uint256",
                    "name": "votes",
                    "type": "uint256"
                }, {
                    "internalType": "bool",
                    "name": "voted",
                    "type": "bool"
                }, {
                    "internalType": "string",
                    "name": "chosenCandidate",
                    "type": "string"
                }],
                "stateMutability": "view",
                "type": "function"
            }];
            contract = new web3.eth.Contract(abi, address);

            // When user clicks the enter button/login button
            $('#login-btn').click(function() {
                // Get account
                web3.eth.getAccounts().then(function(accounts) {

                    // Check if user has voted before
                    contract.methods.getVoterVotes().call({
                        from: accounts[0]
                    }).then(function(voterVotes) {
                        // If user has voted then take user straight to main page
                        if (voterVotes > 0) {
                            window.location.href = "main.html";
                            // Otherwise initialise their voter account
                        } else {
                            web3.eth.getAccounts().then(function(accounts) {
                                window.alert("This may take a few minutes...");
                                window.ethereum.enable()
                                return contract.methods.createVoter().send({
                                    from: accounts[0]
                                });
                            }).then(function(tx) {
                                window.alert("Logging into your was successful. Happy voting!");
                                window.location.href = "main.html";
                            }).catch(function(tx) {
                                console.log(tx);
                                window.alert("Loggin in to your account was unsuccessful... Try logging into metamask?");
                            });
                        };
                    });
                })
            })

        })
    </script>
</body>

</html>